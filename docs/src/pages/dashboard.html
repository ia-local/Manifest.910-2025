<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>Tableau de bord du live</h1>
        <div class="timer">
            <h3>Compte à rebours avant le 10 septembre</h3>
            <div id="dashboard-countdown" class="countdown"></div>
        </div>
    </header>

    <section class="live-tools">
        <h2>Outils du live</h2>
        <div class="card live-script-card">
            <h3>Script du jour</h3>
            <div id="live-script-content">
                <p>Chargement du script...</p>
            </div>
        </div>
        <div class="card ai-chat-card">
            <h3>Assistant IA</h3>
            <div id="ai-chat-history">
                <p>Bienvenue ! Je suis votre assistant IA.</p>
            </div>
            <div class="ai-chat-input">
                <input type="text" id="ai-input" placeholder="Parlez à l'IA...">
                <button id="ai-send-button">Envoyer</button>
            </div>
        </div>
    </section>

    <section class="movement-stats">
        <h2>Statistiques du mouvement</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Caisse de manifestation</h3>
                <p id="caisse-solde">Solde : 0 €</p>
            </div>
            <div class="stat-card">
                <h3>Appels au boycott</h3>
                <p id="boycott-count">0 enseignes listées</p>
            </div>
            <div class="stat-card">
                <h3>Sujets RIC</h3>
                <p id="ric-count">0 propositions actives</p>
            </div>
        </div>
    </section>

    <!-- Nouvelle section pour les bénéficiaires -->
    <section class="beneficiary-stats">
        <h2>Bénéficiaires & Allocations</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Citoyens inscrits</h3>
                <p id="beneficiary-count">0</p>
            </div>
            <div class="stat-card">
                <h3>Allocation mensuelle estimée</h3>
                <p id="monthly-allocation">Calcul en cours...</p>
            </div>
        </div>
    </section>
</div>

<script src="src/js/chrono.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const caisseSoldeEl = document.getElementById('caisse-solde');
        const boycottCountEl = document.getElementById('boycott-count');
        const ricCountEl = document.getElementById('ric-count');
        const beneficiaryCountEl = document.getElementById('beneficiary-count');
        const monthlyAllocationEl = document.getElementById('monthly-allocation');

        const fetchDashboardData = async () => {
            try {
                const response = await fetch('/api/dashboard/summary');
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                // Vérifier que data et les champs nécessaires existent
                if (data && data.caisseSolde !== undefined && data.boycottCount !== undefined && data.ricCount !== undefined) {
                    caisseSoldeEl.textContent = `Solde : ${data.caisseSolde.toFixed(2)} €`;
                    boycottCountEl.textContent = `${data.boycottCount} enseignes listées`;
                    ricCountEl.textContent = `${data.ricCount} propositions actives`;

                    // Simuler les données des bénéficiaires
                    const simulatedBeneficiaries = 1250; 
                    beneficiaryCountEl.textContent = simulatedBeneficiaries;

                    // Calcul simple de l'allocation : solde de la caisse divisé par le nombre de bénéficiaires
                    const currentSolde = data.caisseSolde;
                    const averageAllocation = simulatedBeneficiaries > 0 ? (currentSolde / simulatedBeneficiaries) : 0;
                    
                    monthlyAllocationEl.textContent = `${averageAllocation.toFixed(2)} €`;
                } else {
                    throw new Error("Données de l'API incomplètes ou incorrectes.");
                }

            } catch (error) {
                console.error('Erreur lors de la récupération des données du tableau de bord :', error);
                caisseSoldeEl.textContent = 'Erreur de chargement';
                boycottCountEl.textContent = 'Erreur de chargement';
                ricCountEl.textContent = 'Erreur de chargement';
                beneficiaryCountEl.textContent = 'Erreur';
                monthlyAllocationEl.textContent = 'Erreur';
            }
        };

        // On récupère les données au chargement de la page et toutes les 10 secondes
        fetchDashboardData();
        setInterval(fetchDashboardData, 10000);
    });
</script>